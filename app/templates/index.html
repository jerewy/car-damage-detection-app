<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Damage Assessment Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* SPACING FIXES */
        body {
            background-color: #f8f9fa;
            line-height: 1.8; /* Better readability */
        }
        
        .container {
            max-width: 1200px;
            padding: 40px 20px; /* More padding */
        }
        
        /* Section spacing */
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px; /* Generous padding */
            margin-bottom: 30px; /* Space between sections */
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px; /* Space after titles */
            padding-bottom: 10px;
            border-bottom: 3px solid #007bff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Header spacing */
        .header {
            text-align: center;
            padding: 40px 0;
            background: white;
            color: #212529;
            border-radius: 12px;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .header h1 {
            margin-bottom: 10px;
        }
        
        .header p {
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        /* Metrics card spacing */
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px; /* More padding */
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below cards */
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-card h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 15px 0; /* Space around number */
        }
        
        .metric-card p {
            margin: 0;
            color: #6c757d;
            font-size: 0.95rem;
        }
        
        /* Image spacing */
        .image-container {
            margin: 20px 0; /* Space around images */
            text-align: center;
        }
        
        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            object-fit: contain;
        }
        
        /* Table spacing */
        .table {
            margin-top: 20px;
            margin-bottom: 0;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            padding: 15px; /* More padding */
        }
        
        .table td {
            padding: 15px; /* More padding */
            vertical-align: middle;
        }
        
        /* List spacing */
        .inspection-list {
            list-style: none;
            padding: 0;
        }
        
        .inspection-list li {
            padding: 15px 20px; /* More padding */
            margin-bottom: 12px; /* Space between items */
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 6px;
        }
        
        .inspection-list li strong {
            color: #007bff;
        }
        
        /* Button spacing */
        .action-buttons {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
            text-align: center;
        }
        
        .btn {
            margin: 5px;
            padding: 12px 30px; /* Bigger buttons */
            font-weight: 600;
        }
        
        /* Report ID spacing */
        .report-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        /* Alert/Info box spacing */
        .info-box {
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
            border-left: 5px solid #17a2b8;
            background: #e7f7f9;
        }
        
        /* Loading Overlay */
        #loading {
            display: none;
            text-align: center;
            margin-top: 50px;
        }
        
        /* Print optimization */
        @media print {
            body { 
                background: white !important; 
                color: black !important; 
                font-size: 12pt;
            }
            .container {
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .section {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                margin-bottom: 20px !important;
                break-inside: avoid; /* Prevent cutting sections in half */
                page-break-inside: avoid;
            }
            .metric-card {
                box-shadow: none !important;
                border: 1px solid #eee !important;
                break-inside: avoid;
            }
            .action-buttons, #uploadSection, #loading, .header p small {
                display: none !important;
            }
            .header {
                box-shadow: none !important;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            /* Remove Bootstrap colors for print fidelity */
            .text-primary, .text-success, .text-warning, .text-info {
                color: black !important;
            }
            /* Fix links */
            a { 
                text-decoration: none !important; 
                color: black !important; 
            }
            /* Ensure images fit and don't break */
            img {
                max-width: 100% !important;
                page-break-inside: avoid;
            }
            /* Table readability */
            .table th {
                background-color: #f0f0f0 !important;
                color: black !important;
            }
            
            /* Print specific row/column handling for images */
            .row {
                display: flex !important;
                flex-wrap: nowrap !important;
            }
            .col-md-6 {
                width: 50% !important;
                flex: 0 0 50% !important;
            }
            
            /* Fixed Print Footer */
            .print-footer {
                display: block !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 10px;
                border-top: 1px solid #ccc;
                font-size: 10px;
                text-align: center;
                background: white;
            }
            /* Add padding to body so footer doesn't cover content */
            body {
                padding-bottom: 50px;
            }
        }
        
        .print-footer {
            display: none; /* Hidden on screen */
        }
    </style>
</head>
<body>
    <!-- PRINT FOOTER (Visible only in PDF/Print) -->
    <div class="print-footer">
        <div class="d-flex justify-content-between">
            <span><strong>CONFIDENTIAL INSURANCE DOCUMENT</strong></span>
            <span>Ref ID: <span id="printFooterId">PENDING</span></span>
            <span>Page <span class="pageNumber"></span></span>
        </div>
        <div>Authorized by AutoAssess-AI Automated Systems. Validity subject to physical verification.</div>
    </div>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>Car Damage Assessment Report</h1>
            <p>AI-Powered Visual Inspection & Insurance Reporting</p>
            <p><small>Powered by AutoAssess-AI • YOLO11s • Inference: ~4.5ms</small></p>
        </div>

        <!-- UPLOAD FORM -->
        <div id="uploadSection" class="section">
            <h2 class="section-title"><i class="bi bi-cloud-upload"></i> Upload Vehicle Image</h2>
            <form id="uploadForm">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="vehicleMake" class="form-label">Make</label>
                        <input type="text" class="form-control" id="vehicleMake" placeholder="e.g. Toyota" required>
                    </div>
                    <div class="col-md-4">
                        <label for="vehicleModel" class="form-label">Model</label>
                        <input type="text" class="form-control" id="vehicleModel" placeholder="e.g. Camry" required>
                    </div>
                    <div class="col-md-4">
                        <label for="vehicleYear" class="form-label">Year</label>
                        <input type="number" class="form-control" id="vehicleYear" placeholder="e.g. 2021" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="imageInput" class="form-label">Damage Photo</label>
                    <input class="form-control" type="file" id="imageInput" accept="image/*" required>
                </div>
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Analyze Damage</button>
            </form>
        </div>
        
        <div id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Analyzing image and generating technical report...</p>
        </div>

        <div id="results" style="display: none;">

            <!-- REPORT METADATA -->
            <div class="report-meta">
                <div>
                    <strong>Report ID:</strong> <code id="reportId">DA-2025...</code>
                </div>
                <div>
                    <strong>Generated:</strong> <span id="reportDate">...</span>
                </div>
            </div>

            <!-- VEHICLE INFO -->
            <div class="section">
                <h2 class="section-title"><i class="bi bi-car-front"></i> Vehicle Information</h2>
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>Make:</strong> <span id="resMake">...</span></p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Model:</strong> <span id="resModel">...</span></p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Year:</strong> <span id="resYear">...</span></p>
                    </div>
                </div>
            </div>

            <!-- DETECTION IMAGES -->
            <div class="section">
                <h2 class="section-title"><i class="bi bi-camera"></i> Visual Analysis</h2>
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-center mb-3">Input Image</h5>
                        <div class="image-container d-flex flex-column justify-content-center align-items-center">
                            <img id="originalImage" src="" class="img-fluid" alt="Input">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-center mb-3">Detected Damages</h5>
                        <div class="image-container d-flex flex-column justify-content-center align-items-center">
                            <img id="processedImage" src="" class="img-fluid" alt="Detected">
                        </div>
                    </div>
                </div>
            </div>

            <!-- METRICS DASHBOARD -->
            <div class="section">
                <h2 class="section-title"><i class="bi bi-bar-chart-line"></i> Detection Metrics</h2>
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card border-start border-primary border-5">
                            <p class="text-muted">Total Detections</p>
                            <h2 class="text-primary" id="metricCount">0</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card border-start border-success border-5">
                            <p class="text-muted">Avg Confidence</p>
                            <h2 class="text-success" id="metricConf">0%</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card border-start border-warning border-5">
                            <p class="text-muted">Severity Class</p>
                            <h2 class="text-warning" id="metricSeverity">Medium</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card border-start border-info border-5">
                            <p class="text-muted">Processing Time</p>
                            <h2 class="text-info" id="metricTime">0ms</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DAMAGE BREAKDOWN TABLE -->
            <div class="section">
                <h2 class="section-title"><i class="bi bi-bullseye"></i> Detected Damages Breakdown</h2>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width: 10%">#</th>
                                <th style="width: 25%">Damage Type</th>
                                <th style="width: 30%">Confidence</th>
                                <th style="width: 20%">Severity</th>
                                <th style="width: 15%">Location</th>
                            </tr>
                        </thead>
                        <tbody id="detectionTableBody">
                            <!-- Injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ASSESSMENT SUMMARY -->
            <div class="section">
                <h2 class="section-title"><i class="bi bi-file-text"></i> Technical Assessment</h2>
                
                <div class="info-box" id="aiSummary">
                    <!-- Injected by JS -->
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4 class="mb-3">Severity & Urgency Analysis</h4>
                        <ul class="inspection-list" id="severityList">
                            <!-- Injected by JS -->
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h4 class="mb-3">Repair Estimates</h4>
                        <ul class="inspection-list" id="repairEstList">
                            <!-- Injected by JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- RECOMMENDED NEXT STEPS -->
            <div class="section">
                <h2 class="section-title"><i class="bi bi-check-circle"></i> Recommended Next Steps</h2>
                
                <h5 class="mt-4">Phase 1: Immediate Actions</h5>
                <ul class="inspection-list" id="week1List">
                    <!-- Injected by JS -->
                </ul>

                <h5 class="mt-4">Phase 2: Repair Process</h5>
                <ul class="inspection-list" id="week2List">
                    <!-- Injected by JS -->
                </ul>
            </div>

            <!-- CONTACT INFO -->
            <div class="section">
                <h2 class="section-title"><i class="bi bi-telephone"></i> Contact Information</h2>
                <p>For further information or to schedule a physical inspection, please contact our claims department:</p>
                <ul class="inspection-list">
                    <li><strong><i class="bi bi-phone"></i> Phone:</strong> (555) 123-4567</li>
                    <li><strong><i class="bi bi-envelope"></i> Email:</strong> claims@autoassess-ai.com</li>
                    <li><strong><i class="bi bi-clock"></i> Hours:</strong> Monday-Friday, 8:00 AM - 6:00 PM</li>
                </ul>
            </div>

            <!-- DISCLAIMER -->
            <div class="info-box">
                <strong><i class="bi bi-exclamation-triangle"></i> Important Disclaimer:</strong><br>
                This report is generated by AI computer vision analysis and should be used as a preliminary assessment tool. Final damage evaluation and repair cost estimation require professional in-person inspection by a certified automotive technician or insurance adjuster.
            </div>

            <!-- ACTION BUTTONS -->
            <div class="action-buttons">
                <button class="btn btn-primary btn-lg" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print / Save PDF
                </button>
                <button class="btn btn-secondary btn-lg" onclick="location.reload()">
                    <i class="bi bi-arrow-repeat"></i> Analyze Another Vehicle
                </button>
            </div>
            
            <!-- FOOTER -->
            <div class="text-center mt-5 text-muted">
                <small>
                    Generated by AutoAssess-AI | YOLO11s Detection System<br>
                    Report ID: <span id="footerReportId">...</span> | © 2025 AutoAssess-AI
                </small>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('imageInput');
            if (!fileInput.files[0]) return;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const mk = document.getElementById('vehicleMake').value;
            const md = document.getElementById('vehicleModel').value;
            const yr = document.getElementById('vehicleYear').value;
            formData.append('make', mk);
            formData.append('model', md);
            formData.append('year', yr);

            // UI Updates
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Set Vehicle Info
                    document.getElementById('resMake').textContent = mk;
                    document.getElementById('resModel').textContent = md;
                    document.getElementById('resYear').textContent = yr;
                    
                    // Set Images
                    document.getElementById('originalImage').src = data.original_image;
                    document.getElementById('processedImage').src = data.processed_image;
                    
                    // Set Meta
                    document.getElementById('reportId').textContent = data.report_meta.id;
                    document.getElementById('footerReportId').textContent = data.report_meta.id;
                    document.getElementById('printFooterId').textContent = data.report_meta.id; // Update print footer
                    document.getElementById('reportDate').textContent = data.report_meta.timestamp;

                    // --- METRICS ---
                    const inf = data.inference_data;
                    document.getElementById('metricCount').textContent = inf.count;
                    document.getElementById('metricTime').textContent = inf.processing_time + 'ms';
                    
                    let totalConf = 0;
                    if (inf.detections.length > 0) {
                        inf.detections.forEach(d => totalConf += d.confidence);
                        const avgConf = (totalConf / inf.detections.length * 100).toFixed(1);
                        document.getElementById('metricConf').textContent = avgConf + '%';
                    } else {
                        document.getElementById('metricConf').textContent = '0%';
                    }
                    
                    // Fill Table
                    const tbody = document.getElementById('detectionTableBody');
                    tbody.innerHTML = '';
                    inf.detections.forEach((d, index) => {
                        const confPct = (d.confidence * 100).toFixed(1);
                        const row = `
                            <tr>
                                <td><strong>${index + 1}</strong></td>
                                <td><span class="badge bg-warning text-dark fs-6">${d.class}</span></td>
                                <td>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-success" style="width: ${confPct}%" aria-valuenow="${confPct}">
                                            ${confPct}%
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-warning text-dark">${d.severity}</span></td>
                                <td>${d.location}</td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });

                    // --- JSON REPORT CONTENT ---
                    const r = data.report; 
                    
                    // 1. Summary
                    document.getElementById('aiSummary').innerHTML = `<strong><i class="bi bi-search"></i> Executive Summary:</strong><br>${r.summary}`;
                    
                    // 2. Severity & Urgency
                    document.getElementById('metricSeverity').textContent = r.severity_level || 'Medium';
                    const sevList = document.getElementById('severityList');
                    sevList.innerHTML = `
                        <li><strong>Overall Severity:</strong> ${r.severity_level}<br><small>${r.severity_reasoning}</small></li>
                        <li><strong>Repair Urgency:</strong> ${r.repair_urgency}<br><small>${r.urgency_details}</small></li>
                    `;
                    
                    // 3. Repair Estimates (New Section)
                    const repList = document.getElementById('repairEstList');
                    // Format parts list as string
                    const partsStr = (r.likely_parts_needed && r.likely_parts_needed.length > 0) 
                        ? r.likely_parts_needed.join(", ") 
                        : "No specific parts listed.";

                    repList.innerHTML = `
                        <li><strong>Est. Cost Range:</strong> ${r.cost_range}<br><small>${r.cost_details}</small></li>
                        <li><strong>Est. Labor Hours:</strong> ${r.estimated_labor_hours || 'N/A'}</li>
                        <li><strong>Likely Parts:</strong> ${partsStr}</li>
                        <li><strong>Primary Rec:</strong> ${r.recommended_action}</li>
                    `;

                    // 4. Next Steps
                    const w1List = document.getElementById('week1List');
                    w1List.innerHTML = '';
                    r.immediate_actions.forEach(action => {
                        w1List.insertAdjacentHTML('beforeend', `<li>${action}</li>`);
                    });
                    
                    const w2List = document.getElementById('week2List');
                    w2List.innerHTML = '';
                    r.secondary_actions.forEach(action => {
                        w2List.insertAdjacentHTML('beforeend', `<li>${action}</li>`);
                    });

                    document.getElementById('results').style.display = 'block';
                } else {
                    alert('Error: ' + data.message);
                    document.getElementById('uploadSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing the image.');
                document.getElementById('uploadSection').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });
    </script>
</body>
</html>